# 窗户生成功能设计文档

## 1. 功能概述

窗户生成功能是工厂布局导入系统的重要组成部分，负责在墙体上创建窗户开口和独立窗户实体。该功能支持两种类型的窗户：墙体窗户（在现有墙体上开洞）和独立窗户（独立存在的窗户实体），具有智能的尺寸标准化和位置投影功能。

## 2. 设计思路

### 2.1 核心设计理念
- **滞后创建策略**：确保墙体已存在后再创建窗户
- **智能尺寸标准化**：自动处理不同单位的尺寸数据
- **精确位置投影**：将窗户位置精确投影到墙体上
- **容错机制**：完善的错误处理和参数验证

### 2.2 窗户类型分类
1. **墙体窗户**：在现有墙体上创建开口
   - 支持不同厚度的墙体
   - 精确的位置和尺寸控制
2. **独立窗户**（未做测试）：独立存在的窗户实体
   - 可自由放置的窗户组件
   - 支持旋转和缩放

### 2.3 处理流程
1. **数据验证**：检查窗户和墙体数据的有效性
2. **类型判断**：区分墙体窗户和独立窗户
3. **尺寸标准化**：统一处理不同单位的尺寸数据
4. **位置投影**：将窗户位置投影到墙体上
5. **几何计算**：计算窗户开口的精确位置和尺寸
6. **实体创建**：在SketchUp中创建窗户开口或窗户实体

## 3. 模块结构

### 3.1 WindowBuilder模块

#### 主要功能
- 批量窗户创建管理
- 墙体窗户开口生成
- 独立窗户实体创建
- 智能尺寸标准化

#### 核心函数说明

**`create_all_windows(window_data_list, parent_group)`**
- **作用**：批量创建所有窗户，统一管理创建流程
- **参数**：窗户数据列表、父组对象
- **前置条件**：墙体已创建完成，窗户数据包含有效的window_data和wall_data

**`create_wall_window(wall_group, wall_data, window_data)`**
- **作用**：在墙体上创建窗户开口
- **参数**：墙体组、墙体数据、窗户数据
- **前置条件**：墙体组存在，窗户数据有效

**`create_window_on_wall(wall_group, wall_data, window_data, position, width_mm, height_mm, height_pos_mm, wall_thickness_mm)`**
- **作用**：在墙体上创建窗户的主要方法
- **参数**：墙体组、墙体数据、窗户数据、位置、宽度、高度、离地高度、墙体厚度
- **前置条件**：所有参数有效，墙体厚度大于0

**`create_independent_window(window_data, parent_group)`**
- **作用**：创建独立窗户实体
- **参数**：窗户数据、父组
- **前置条件**：窗户位置数据有效

**`validate_window_data(window_data)`**
- **作用**：验证窗户数据的有效性
- **参数**：窗户数据
- **返回**：布尔值，表示数据是否有效

**`normalize_to_millimeters(value, default_value)`**
- **作用**：将尺寸值标准化为毫米单位
- **参数**：原始值、默认值
- **返回**：标准化后的毫米值

## 4. 配置参数

### 4.1 窗户尺寸参数
```ruby
# 默认窗户尺寸（毫米）
DEFAULT_WIDTH = 1000        # 默认窗户宽度
DEFAULT_HEIGHT = 1500       # 默认窗户高度
DEFAULT_THICKNESS = 50      # 默认窗户厚度（仅独立窗户用）
DEFAULT_HEIGHT_POS = 1500   # 默认中心点高度
```

### 4.2 单位转换参数
```ruby
# 单位转换因子
MILLIMETER_TO_INCH = 0.0393701  # 毫米转英寸
INCH_TO_MILLIMETER = 25.4       # 英寸转毫米

# 尺寸验证阈值
MIN_WINDOW_WIDTH = 100      # 最小窗户宽度（毫米）
MIN_WINDOW_HEIGHT = 100     # 最小窗户高度（毫米）
MAX_WINDOW_WIDTH = 10000    # 最大窗户宽度（毫米）
MAX_WINDOW_HEIGHT = 10000   # 最大窗户高度（毫米）
```

### 4.3 几何计算参数
```ruby
# 投影和几何计算阈值
MIN_VECTOR_LENGTH = 0.001   # 最小向量长度
MIN_WALL_LENGTH = 0.001     # 最小墙体长度
PROJECTION_TOLERANCE = 0.001 # 投影容差
```

## 5. 前置条件

### 5.1 数据要求
- 窗户数据必须包含有效的位置信息（position）
- 窗户尺寸数据（size数组，至少包含宽度和高度）
- 墙体窗户需要对应的墙体数据（wall_data）
- 所有坐标必须是有效的数值

### 5.2 环境要求
- SketchUp环境已初始化
- 父组对象存在且有效
- 墙体已创建完成（对于墙体窗户）
- 模型处于可编辑状态

### 5.3 依赖模块
- `Utils`模块：提供点验证、数值解析和UTF-8编码处理
- `Geom`模块：提供几何计算功能
- SketchUp API：提供实体创建和变换功能

## 6. 关键代码展示

### 6.1 智能尺寸标准化
```ruby
def self.normalize_to_millimeters(value, default_value)
  return default_value if value.nil?
  
  # 如果已经是数值，假设是毫米
  if value.is_a?(Numeric)
    return value.to_f
  end
  
  # 如果是字符串，尝试解析
  if value.is_a?(String)
    # 移除空格并转换为小写
    clean_value = value.strip.downcase
    
    # 检查是否包含单位标识
    if clean_value.include?("mm") || clean_value.include?("毫米")
      return clean_value.gsub(/[^\d.]/, '').to_f
    elsif clean_value.include?("cm") || clean_value.include?("厘米")
      return clean_value.gsub(/[^\d.]/, '').to_f * 10
    elsif clean_value.include?("m") || clean_value.include?("米")
      return clean_value.gsub(/[^\d.]/, '').to_f * 1000
    elsif clean_value.include?("inch") || clean_value.include?("英寸")
      return clean_value.gsub(/[^\d.]/, '').to_f * 25.4
    else
      # 假设是毫米
      return clean_value.to_f
    end
  end
  
  default_value
end
```

### 6.2 窗户数据验证
```ruby
def self.validate_window_data(window_data)
  return false unless window_data && window_data.is_a?(Hash)
  
  # 检查必要字段
  required_fields = ["position", "size"]
  required_fields.each do |field|
    unless window_data[field]
      puts "警告: 窗户数据缺少必要字段: #{field}"
      return false
    end
  end
  
  # 验证位置数据
  position = window_data["position"]
  unless position && position.is_a?(Array) && position.size >= 2
    puts "警告: 窗户位置数据无效"
    return false
  end
  
  # 验证尺寸数据
  size = window_data["size"]
  unless size && size.is_a?(Array) && size.size >= 2
    puts "警告: 窗户尺寸数据无效"
    return false
  end
  
  true
end
```

### 6.3 墙体窗户创建
```ruby
def self.create_window_on_wall(wall_group, wall_data, window_data, position, width_mm, height_mm, height_pos_mm, wall_thickness_mm)
  puts "=== 开始创建墙体窗户 ==="
  
  model = Sketchup.active_model
  model.start_operation("创建墙体窗户", true)
  
  # 获取墙体信息
  wall_start = Utils.validate_and_create_point(wall_data["start"])
  wall_end = Utils.validate_and_create_point(wall_data["end"])
  
  # 将窗户位置投影到墙体上
  projected_position = project_point_to_wall(position, wall_start, wall_end)
  
  # 计算窗户开口的几何参数
  window_points = calculate_window_points(projected_position, width_mm, height_mm, height_pos_mm, wall_thickness_mm)
  
  # 创建窗户开口面
  wall_entities = wall_group.entities
  window_face = wall_entities.add_face(window_points)
  
  if window_face
    # 沿Z轴负方向挖洞（向内）
    window_face.pushpull(-wall_thickness_mm / 25.4)
    puts "窗户开口创建成功"
  end
  
  model.commit_operation
rescue => e
  model.abort_operation if model
  puts "创建窗户失败: #{Utils.ensure_utf8(e.message)}"
end
```

### 6.4 独立窗户创建
```ruby
def self.create_independent_window(window_data, parent_group)
  position = Utils.validate_and_create_point(window_data["position"])
  
  if !position
    puts "警告: 独立窗户位置无效，跳过"
    return
  end
  
  # 提取窗户尺寸
  size = window_data["size"] || []
  width = normalize_to_millimeters(size[0], DEFAULT_WIDTH)
  height = normalize_to_millimeters(size[1], DEFAULT_HEIGHT)
  thickness = normalize_to_millimeters(size[2], DEFAULT_THICKNESS)
  
  # 创建窗户组
  window_group = parent_group.entities.add_group
  window_group.name = window_data["name"] || "独立窗户"
  
  # 创建窗户的四个角点
  points = [
    position,
    position + Geom::Vector3d.new(width / 25.4, 0, 0),
    position + Geom::Vector3d.new(width / 25.4, 0, height / 25.4),
    position + Geom::Vector3d.new(0, 0, height / 25.4)
  ]
  
  # 应用旋转（如果有）
  orientation = Utils.parse_number(window_data["orientation"] || 0.0)
  if orientation != 0
    rotation = Geom::Transformation.rotation(position, Geom::Vector3d.new(0, 0, 1), orientation * Math::PI / 180)
    points.map! { |p| p.transform(rotation) }
  end
  
  # 创建窗户的面并拉伸
  window_face = window_group.entities.add_face(points)
  window_face.pushpull(thickness / 25.4) if window_face
  
  puts "创建独立窗户成功: #{window_group.name}"
end
```

## 7. 使用流程

### 7.1 基本使用
```ruby
# 批量创建所有窗户
window_data_list = [
  {
    window_data: { 
      "id" => "window1", 
      "position" => [5, 0, 1.5], 
      "size" => [1000, 1500, 50],
      "height" => 1500 
    },
    wall_data: { 
      "id" => "wall1", 
      "start" => [0, 0, 0], 
      "end" => [10, 0, 0], 
      "thickness" => 200 
    },
    parent_group: wall_group
  }
]

WindowBuilder.create_all_windows(window_data_list, parent_group)
```

### 7.2 单独创建墙体窗户
```ruby
# 在墙体上创建窗户开口
WindowBuilder.create_wall_window(wall_group, wall_data, window_data)
```

### 7.3 创建独立窗户
```ruby
# 创建独立窗户
window_data = {
  "id" => "independent_window1",
  "position" => [x, y, z],
  "size" => [width, height, thickness],
  "orientation" => 45
}

WindowBuilder.create_independent_window(window_data, parent_group)
```

## 8. 错误处理

### 8.1 数据验证
- 检查窗户位置和尺寸数据的完整性
- 验证坐标点的有效性
- 确保墙体数据存在且有效

### 8.2 几何验证
- 检查投影参数的有效性
- 验证窗户开口四点能形成有效面
- 确保窗户尺寸合理

### 8.3 异常捕获
- 使用begin-rescue块包装主要操作
- 提供详细的错误日志和调试信息
- 确保程序在出错时能够继续运行

## 9. 性能考虑

### 9.1 算法优化
- 高效的尺寸标准化算法
- 优化的投影计算
- 合理的几何计算

### 9.2 内存管理
- 及时清理临时变量
- 避免创建过多中间对象
- 使用适当的数据结构

### 9.3 操作管理
- 使用SketchUp的操作管理
- 确保操作的原子性
- 在出错时正确回滚操作

## 10. 扩展性

### 10.1 窗户类型扩展
- 支持不同类型的窗户（推拉窗、平开窗等）
- 可添加窗户的材质和纹理
- 支持窗户的动画效果

### 10.2 几何算法扩展
- 支持更复杂的墙体形状
- 可添加窗户的装饰元素
- 支持窗户的自动尺寸调整

### 10.3 配置灵活性
- 支持自定义窗户尺寸参数
- 可调整投影算法参数
- 支持不同的单位系统

---
 