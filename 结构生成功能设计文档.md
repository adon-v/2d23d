# 结构生成功能设计文档

## 1. 功能概述

结构生成功能是工厂布局导入系统的基础组件，负责创建工厂内的各种结构元素，包括柱子、通道和其他结构对象。该功能支持复杂几何形状的创建，具有智能的尺寸调整和材质管理功能，为工厂布局提供完整的结构支持。

## 2. 设计思路

### 2.1 核心设计理念
- **结构元素创建**：支持柱子、通道和各种结构对象
- **智能尺寸处理**：自动处理不同单位的尺寸数据
- **材质管理**：为不同结构元素分配合适的材质
- **容错机制**：完善的错误处理和参数验证

### 2.2 结构类型分类
1. **柱子**：建筑物的支撑结构
   - 支持多边形截面
   - 可调节高度
   - 统一的材质和颜色
2. **其他对象**：各种结构元素
   - 灵活的形状定义
   - 可自定义属性

### 2.3 处理流程
1. **数据验证**：检查结构数据的有效性
2. **几何计算**：计算结构元素的几何参数
3. **实体创建**：在SketchUp中创建结构实体
4. **尺寸调整**：根据参数调整结构尺寸
5. **材质应用**：为结构元素应用材质
6. **属性设置**：设置结构元素的属性

## 3. 模块结构

### 3.1 StructureBuilder模块

#### 主要功能
- 批量结构导入
- 柱子创建和管理
- 对象创建和管理

#### 核心函数说明

**`import_columns(columns_data, parent_group)`**
- **作用**：批量导入所有柱子
- **参数**：柱子数据数组、父组对象
- **前置条件**：柱子数据包含有效的points信息

**`import_objects(objects_data, parent_group)`**
- **作用**：批量导入所有对象
- **参数**：对象数据数组、父组对象
- **前置条件**：对象数据包含有效的位置和尺寸信息

**`create_column(column_data, parent_group)`**
- **作用**：创建单个柱子
- **参数**：柱子数据、父组
- **前置条件**：柱子数据有效

**`create_object(object_data, parent_group)`**
- **作用**：创建单个对象
- **参数**：对象数据、父组
- **前置条件**：对象数据有效

## 4. 配置参数

### 4.1 柱子参数
```ruby
# 柱子默认参数
DEFAULT_COLUMN_HEIGHT = 10000    # 默认柱子高度（毫米）
DEFAULT_COLUMN_MATERIAL = [128, 128, 128]  # 默认柱子材质（灰色）

# 柱子验证参数
MIN_COLUMN_HEIGHT = 1000         # 最小柱子高度（毫米）
MAX_COLUMN_HEIGHT = 50000        # 最大柱子高度（毫米）
MIN_COLUMN_POINTS = 3            # 最小柱子点数
```

### 4.2 对象参数
```ruby
# 对象默认参数
DEFAULT_OBJECT_WIDTH = 1.0       # 默认对象宽度（米）
DEFAULT_OBJECT_LENGTH = 1.0      # 默认对象长度（米）
DEFAULT_OBJECT_HEIGHT = 1.0      # 默认对象高度（米）
DEFAULT_OBJECT_ORIENTATION = 0.0 # 默认对象旋转角度

# 对象验证参数
MIN_OBJECT_SIZE = 0.001          # 最小对象尺寸（米）
MAX_OBJECT_SIZE = 100.0          # 最大对象尺寸（米）
```

### 4.3 单位转换参数
```ruby
# 单位转换
INCH_SCALE_FACTOR = 25.4         # 英寸缩放因子
MILLIMETER_TO_INCH = 0.0393701   # 毫米转英寸
INCH_TO_MILLIMETER = 25.4        # 英寸转毫米

# 几何验证阈值
MIN_VECTOR_LENGTH = 0.001        # 最小向量长度
MIN_POLYGON_AREA = 0.001         # 最小多边形面积
```

## 5. 前置条件

### 5.1 数据要求
- 柱子数据必须包含有效的points数组（至少3个点）
- 柱子高度数据（可选，有默认值）
- 对象数据必须包含有效的位置信息
- 对象尺寸数据（可选，有默认值）

### 5.2 环境要求
- SketchUp环境已初始化
- 父组对象存在且有效
- 模型处于可编辑状态

### 5.3 依赖模块
- `Utils`模块：提供点验证、数值解析和UTF-8编码处理
- `Geom`模块：提供几何计算功能
- SketchUp API：提供实体创建和变换功能

## 6. 关键代码展示

### 6.1 柱子导入主流程
```ruby
def self.import_columns(columns_data, parent_group)
  inch_scale_factor = 25.4
  columns_data.each do |column_data|
    begin
      # 验证输入数据
      unless column_data && column_data["points"]
        puts "警告: 立柱数据不完整，跳过"
        next
      end
      
      points = column_data["points"].map { |point| Utils.validate_and_create_point(point) }.compact
      next if points.size < 3
      
      puts "创建立柱: #{column_data['name'] || column_data['id']}"
      puts "立柱点数: #{points.size}"
      
      # 验证点的有效性
      valid_points = points.select { |pt| pt && pt.is_a?(Geom::Point3d) }
      if valid_points.size < 3
        puts "警告: 立柱有效点数不足，跳过"
        next
      end
      
      # 创建立柱面
      column_face = parent_group.entities.add_face(valid_points)
      unless column_face && column_face.is_a?(Sketchup::Face)
        puts "警告: 无法创建立柱面，跳过"
        next
      end
      
      # 设置立柱高度
      height = Utils.parse_number(column_data["height"] || 10000)
      height = 10000 if height <= 0  # 默认10米
      height = height / inch_scale_factor  # 转换为英寸
      
      # 拉伸立柱
      begin
        puts "开始拉伸立柱，高度: #{height}英寸"
        column_face.pushpull(-height)
        puts "立柱拉伸成功，高度: #{height}英寸 (#{height * 0.0254}米)"
      rescue => e
        puts "立柱拉伸失败: #{e.message}"
        puts "立柱数据: #{column_data.inspect}"
        puts "立柱点: #{valid_points.inspect}"
      end
      
      # 设置立柱材质和颜色
      begin
        column_face.material = [128, 128, 128]  # 灰色
        column_face.back_material = [128, 128, 128]
        puts "立柱材质设置成功"
      rescue => e
        puts "立柱材质设置失败: #{e.message}"
      end
      
      # 设置立柱属性
      begin
        column_face.set_attribute('FactoryImporter', 'element_type', 'column')
        column_face.set_attribute('FactoryImporter', 'column_name', column_data['name'] || '立柱')
        column_face.set_attribute('FactoryImporter', 'column_id', column_data['id'])
      rescue => e
        puts "立柱属性设置失败: #{e.message}"
      end
      
      puts "立柱创建成功: #{column_data['name'] || column_data['id']}"
      
    rescue => e
      puts "创建立柱失败: #{Utils.ensure_utf8(e.message)}"
      puts "立柱数据: #{column_data.inspect}"
    end
  end
end
```

### 6.2 对象导入主流程
```ruby
def self.import_objects(objects_data, parent_group)
  objects_data.each do |object_data|
    begin
      position = Utils.validate_and_create_point(object_data["position"])
      next if !position
      
      size = object_data["size"] || []
      width = Utils.parse_number(size[0] || 1.0)
      length = Utils.parse_number(size[1] || 1.0)
      height = Utils.parse_number(size[2] || 1.0)
      
      width = 1.0 if width <= 0
      length = 1.0 if length <= 0
      height = 1.0 if height <= 0
      
      orientation = Utils.parse_number(object_data["orientation"] || 0.0)
      
      object_group = parent_group.entities.add_group
      object_group.name = object_data["type"] || "对象"
      
      # 创建对象的四个角点
      points = [
        position,
        position + Geom::Vector3d.new(width, 0, 0),
        position + Geom::Vector3d.new(width, length, 0),
        position + Geom::Vector3d.new(0, length, 0)
      ]
      
      # 应用旋转（如果有）
      if orientation != 0
        rotation = Geom::Transformation.rotation(position, Geom::Vector3d.new(0, 0, 1), orientation * Math::PI / 180)
        points.map! { |p| p.transform(rotation) }
      end
      
      # 创建对象的面并拉伸
      object_face = object_group.entities.add_face(points)
      if object_face
        object_face.pushpull(height)
        
        # 设置对象材质
        object_face.material = [200, 200, 200]  # 浅灰色
        object_face.back_material = [200, 200, 200]
        
        # 设置对象属性
        object_face.set_attribute('FactoryImporter', 'element_type', 'object')
        object_face.set_attribute('FactoryImporter', 'object_type', object_data["type"] || "对象")
        object_face.set_attribute('FactoryImporter', 'object_id', object_data["id"])
      end
      
      puts "创建对象成功: #{object_group.name}"
      
    rescue => e
      puts "创建对象失败: #{Utils.ensure_utf8(e.message)}"
      puts "对象数据: #{object_data.inspect}"
    end
  end
end
```

### 6.3 柱子数据验证
```ruby
def self.validate_column_data(column_data)
  return false unless column_data && column_data.is_a?(Hash)
  
  # 检查必要字段
  unless column_data["points"]
    puts "警告: 柱子数据缺少points字段"
    return false
  end
  
  # 验证points数组
  points = column_data["points"]
  unless points && points.is_a?(Array) && points.size >= 3
    puts "警告: 柱子points数据无效，至少需要3个点"
    return false
  end
  
  # 验证每个点的有效性
  valid_points = points.map { |point| Utils.validate_and_create_point(point) }.compact
  if valid_points.size < 3
    puts "警告: 柱子有效点数不足，至少需要3个有效点"
    return false
  end
  
  true
end
```

### 6.4 对象数据验证
```ruby
def self.validate_object_data(object_data)
  return false unless object_data && object_data.is_a?(Hash)
  
  # 检查必要字段
  unless object_data["position"]
    puts "警告: 对象数据缺少position字段"
    return false
  end
  
  # 验证位置数据
  position = Utils.validate_and_create_point(object_data["position"])
  unless position
    puts "警告: 对象位置数据无效"
    return false
  end
  
  # 验证尺寸数据（可选）
  size = object_data["size"]
  if size && size.is_a?(Array)
    if size.size < 3
      puts "警告: 对象尺寸数据不完整，需要3个值（宽度、长度、高度）"
      return false
    end
    
    # 验证尺寸值的有效性
    size.each_with_index do |dim, index|
      dim_value = Utils.parse_number(dim)
      if dim_value && dim_value <= 0
        puts "警告: 对象尺寸值无效，索引#{index}: #{dim}"
        return false
      end
    end
  end
  
  true
end
```

### 6.5 几何计算辅助函数
```ruby
def self.calculate_polygon_center(points)
  return nil if points.empty?
  
  # 计算多边形的质心
  sum_x = points.sum { |p| p.x }
  sum_y = points.sum { |p| p.y }
  sum_z = points.sum { |p| p.z }
  
  count = points.size.to_f
  Geom::Point3d.new(sum_x / count, sum_y / count, sum_z / count)
end

def self.calculate_polygon_area(points)
  return 0 if points.size < 3
  
  # 使用鞋带公式计算多边形面积
  area = 0
  n = points.size
  
  (0...n).each do |i|
    j = (i + 1) % n
    area += points[i].x * points[j].y
    area -= points[j].x * points[i].y
  end
  
  area.abs / 2.0
end

def self.is_polygon_valid(points)
  return false if points.size < 3
  
  # 检查多边形是否有效（面积大于0）
  area = calculate_polygon_area(points)
  area > MIN_POLYGON_AREA
end
```

## 7. 使用流程

### 7.1 基本使用
```ruby
# 批量导入柱子
columns_data = [
  {
    "id" => "column1",
    "name" => "立柱1",
    "points" => [
      [0, 0, 0],
      [0.5, 0, 0],
      [0.5, 0.5, 0],
      [0, 0.5, 0]
    ],
    "height" => 3000
  }
]

StructureBuilder.import_columns(columns_data, parent_group)
```

### 7.2 批量导入对象
```ruby
# 批量导入对象
objects_data = [
  {
    "id" => "object1",
    "type" => "设备基础",
    "position" => [1, 1, 0],
    "size" => [2, 2, 0.5],
    "orientation" => 45
  }
]

StructureBuilder.import_objects(objects_data, parent_group)
```

### 7.3 单独创建柱子
```ruby
# 创建单个柱子
column_data = {
  "id" => "column2",
  "name" => "立柱2",
  "points" => [
    [5, 5, 0],
    [5.3, 5, 0],
    [5.3, 5.3, 0],
    [5, 5.3, 0]
  ],
  "height" => 4000
}

StructureBuilder.create_column(column_data, parent_group)
```

## 8. 错误处理

### 8.1 数据验证
- 检查结构数据的完整性
- 验证几何参数的有效性
- 确保点数足够形成有效几何体

### 8.2 几何验证
- 检查多边形是否有效
- 验证尺寸参数合理性
- 确保拉伸操作成功

### 8.3 异常捕获
- 使用begin-rescue块包装主要操作
- 提供详细的错误日志
- 确保程序在出错时能够继续运行

## 9. 性能考虑

### 9.1 算法优化
- 高效的几何计算算法
- 优化的批量处理
- 合理的验证策略

### 9.2 内存管理
- 及时清理临时变量
- 避免创建过多中间对象
- 使用适当的数据结构

### 9.3 渲染优化
- 批量处理结构创建
- 优化材质应用
- 减少不必要的几何计算

## 10. 扩展性

### 10.1 结构类型扩展
- 支持更多结构类型（梁、板等）
- 可添加结构层级关系
- 支持结构的动态更新

### 10.2 几何算法扩展
- 支持更复杂的几何形状
- 可添加结构的装饰元素
- 支持结构的自动优化

### 10.3 功能扩展
- 支持结构的交互操作
- 可添加结构标签和注释
- 支持结构的统计分析

---
 