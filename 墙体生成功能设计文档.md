# 墙体生成功能设计文档

## 1. 功能概述

墙体生成功能是工厂布局导入系统的基础组件，负责创建建筑物的墙体结构。该功能支持垂直墙体的生成，包括外墙和内墙，具有智能的外墙重合检测和实体存储管理功能。

## 2. 设计思路

### 2.1 核心设计理念
- **垂直墙体生成**：专注于创建垂直的墙体结构
- **外墙重合检测**：智能识别并避免与外墙的重合
- **实体存储管理**：将墙体信息存储到实体存储器中
- **容错机制**：完善的错误处理和参数验证

### 2.2 墙体类型分类
1. **外墙**：建筑物的外围墙体
2. **内墙**：建筑物内部的隔断墙体
3. **零厚度墙体**：特殊用途的薄墙体

### 2.3 处理流程
1. **外墙收集**：收集所有外墙线段信息
2. **数据验证**：检查墙体数据的有效性
3. **重合检测**：判断是否与外墙重合
4. **几何计算**：计算墙体的几何参数
5. **实体创建**：在SketchUp中创建墙体实体
6. **属性设置**：设置墙体属性和存储信息

## 3. 模块结构

### 3.1 WallBuilder模块

#### 主要功能
- 批量墙体导入
- 外墙重合检测
- 垂直墙体创建
- 实体存储管理

#### 核心函数说明

**`import_walls(walls_data, parent_group)`**
- **作用**：批量导入所有墙体
- **参数**：墙体数据数组、父组对象
- **前置条件**：墙体数据包含有效的起点和终点坐标

**`create_vertical_wall(wall_data, start_point, end_point, thickness, height, normal, parent_group)`**
- **作用**：创建单个垂直墙体
- **参数**：墙体数据、起点、终点、厚度、高度、法向量、父组
- **前置条件**：所有几何参数有效

## 4. 配置参数

### 4.1 墙体尺寸参数
```ruby
# 默认墙体参数
DEFAULT_WALL_THICKNESS = 0.2    # 默认墙体厚度（米）
DEFAULT_WALL_HEIGHT = 3.0       # 默认墙体高度（米）

# 单位转换
SCALE_FACTOR = 25.4             # 毫米转英寸的缩放因子

# 几何验证阈值
MIN_VECTOR_LENGTH = 0.001       # 最小向量长度
MIN_WALL_LENGTH = 0.001         # 最小墙体长度
```

### 4.2 外墙检测参数
```ruby
# 外墙识别关键词
OUTWALL_KEYWORDS = ["outwall", "外墙"]

# 重合检测阈值
COINCIDENCE_THRESHOLD = 0.001   # 重合检测距离阈值
```

## 5. 前置条件

### 5.1 数据要求
- 墙体数据必须包含有效的起点和终点坐标
- 墙体厚度和高度数据（可选，有默认值）
- 墙体ID或名称用于标识

### 5.2 环境要求
- SketchUp环境已初始化
- 父组对象存在且有效
- 模型处于可编辑状态

### 5.3 依赖模块
- `Utils`模块：提供点验证和数值解析
- `Geom`模块：提供几何计算功能
- `EntityStorage`模块：提供实体存储功能
- SketchUp API：提供实体创建功能

## 6. 关键代码展示

### 6.1 外墙重合检测
```ruby
# 收集所有外墙线段
outwall_edges = []
parent_group.entities.grep(Sketchup::Group).each do |group|
  name = group.name.downcase
  if name.include?("outwall") || name.include?("外墙")
    group.entities.grep(Sketchup::Face).each do |face|
      face.edges.each do |edge|
        outwall_edges << [edge.start.position, edge.end.position]
      end
    end
  end
end

# 判断与外墙重合
skip = false
if thickness > 0 && !outwall_edges.empty?
  outwall_edges.each do |ow_s, ow_e|
    if (start_point.distance(ow_s) < 0.001 && end_point.distance(ow_e) < 0.001) ||
       (start_point.distance(ow_e) < 0.001 && end_point.distance(ow_s) < 0.001)
      skip = true
      break
    end
  end
end
```

### 6.2 墙体法向量计算
```ruby
# 计算墙体方向向量
vector = end_point - start_point
if vector.length < 0.001
  puts "警告: 墙的起点和终点相同，无法创建"
  next
end

# 计算法向量
begin
  normal = vector.cross(Geom::Vector3d.new(0, 0, 1)).normalize
  normal = normal.reverse if normal.x < 0
rescue
  normal = Geom::Vector3d.new(1, 0, 0)
end
```

### 6.3 实体存储管理
```ruby
# 存储到实体存储器
begin
  EntityStorage.add_entity("wall", wall_group, {
    wall_id: wall_id,
    wall_name: wall_data["name"],
    start_point: wall_data["start"],
    end_point: wall_data["end"],
    thickness: thickness,
    height: height
  })
  
  # 设置实体名称
  wall_name = wall_data["name"] || "未命名墙体"
  wall_group.name = "墙体_#{wall_name}_#{wall_id}"
rescue => e
  puts "警告: 存储墙体实体失败: #{e.message}"
end
```

## 7. 使用流程

### 7.1 基本使用
```ruby
# 批量导入墙体
walls_data = [
  {
    "id" => "wall1",
    "name" => "外墙1",
    "start" => [0, 0, 0],
    "end" => [10, 0, 0],
    "thickness" => 200,
    "height" => 3000
  }
]

WallBuilder.import_walls(walls_data, parent_group)
```

## 8. 错误处理

### 8.1 数据验证
- 检查墙体起点和终点的有效性
- 验证厚度和高度参数
- 确保向量长度合理

### 8.2 几何验证
- 检查墙体向量是否为零向量
- 验证法向量计算的有效性
- 确保墙体能形成有效面

### 8.3 异常捕获
- 使用begin-rescue块包装主要操作
- 提供详细的错误日志
- 确保程序在出错时能够继续运行

## 9. 性能考虑

### 9.1 算法优化
- 高效的外墙线段收集
- 优化的重合检测算法
- 合理的几何计算

### 9.2 内存管理
- 及时清理临时变量
- 避免创建过多中间对象
- 使用适当的数据结构

## 10. 扩展性

### 10.1 墙体类型扩展
- 支持倾斜墙体
- 可添加墙体材质和纹理
- 支持墙体装饰元素

### 10.2 功能扩展
- 支持更复杂的墙体形状
- 可添加墙体开洞功能
- 支持墙体的自动优化

---
 