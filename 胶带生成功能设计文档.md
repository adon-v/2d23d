# 胶带生成功能设计文档

## 1. 功能概述

胶带生成功能是工厂布局导入系统的重要组成部分，用于在区域边界生成可视化的胶带标识。该功能通过几何算法计算区域边界的偏移多边形，生成具有特定宽度、高度和材质的胶带实体。

## 2. 设计思路

### 2.1 核心算法：偏移减法法
胶带生成采用"大区域减去小区域"的设计思路：
- **大区域**：原始区域向外偏移半个胶带宽度
- **小区域**：原始区域向内偏移半个胶带宽度  
- **胶带区域**：大区域减去小区域，形成环形胶带

### 2.2 几何处理流程
1. **点验证**：确保输入点坐标有效且数量足够（≥3个点）
2. **偏移计算**：计算每个边的法向量，生成偏移线段
3. **交点计算**：计算相邻偏移线段的交点，形成闭合多边形
4. **布尔运算**：大区域减去小区域，生成胶带形状
5. **实体创建**：在SketchUp中创建胶带面并设置属性

### 2.3 分层设计
- **TapeBuilder模块**：负责胶带生成的算法逻辑
- **Tape类**：封装胶带对象的属性和创建方法
- **材质管理**：统一的颜色和材质配置

## 3. 模块结构

### 3.1 TapeBuilder模块

#### 主要功能
- 区域边界胶带生成
- 外部区域边界胶带生成
- 几何算法实现

#### 核心函数说明

**`generate_zone_boundary_tapes(zones_data, parent_group)`**
- **作用**：批量生成区域边界胶带
- **参数**：区域数据数组、父组对象
- **前置条件**：区域数据包含有效的shape.points数组

**`generate_tape_by_offset_subtraction(points, zone_name, parent_group, tape_layer, is_outdoor)`**
- **作用**：使用偏移减法算法生成单个胶带
- **参数**：区域点集、区域名称、父组、胶带层、是否外部区域
- **前置条件**：点集至少包含3个有效点

**`generate_offset_polygon(original_points, offset_distance)`**
- **作用**：生成偏移多边形
- **参数**：原始点集、偏移距离
- **前置条件**：原始点集形成有效多边形

**`calculate_line_intersection(p1, p2, q1, q2)`**
- **作用**：计算两条线段的交点
- **参数**：两条线段的端点坐标
- **返回**：交点坐标或nil（如果线段平行）

### 3.2 Tape类

#### 主要功能
- 封装胶带对象的属性
- 统一胶带面创建逻辑
- 属性设置和日志记录

#### 核心方法说明

**`initialize(points, zone_name, parent_group, is_shared:, tape_type:, additional_attrs:)`**
- **作用**：初始化胶带对象
- **参数**：点集、区域名称、父组、是否共享、胶带类型、额外属性

**`create_face`**
- **作用**：创建胶带面并设置所有属性
- **前置条件**：点集至少包含3个有效点

## 4. 配置参数

### 4.1 TapeBuilder配置
```ruby
TAPE_COLOR = [255, 255, 0, 255]      # 黄色，完全不透明
TAPE_WIDTH = 5                        # 胶带宽度（米）
TAPE_HEIGHT_OFFSET = 0.5              # 胶带上浮高度（米）
TAPE_THICKNESS = 0.1                  # 胶带厚度（米）
```

### 4.2 Tape类配置
```ruby
TAPE_COLOR = [255, 255, 0, 255]      # 黄色，完全不透明
SHARED_TAPE_COLOR = [255, 165, 0, 255] # 橙色，共享边界
TAPE_WIDTH = 0.05                     # 胶带宽度（米）
TAPE_HEIGHT_OFFSET = 0.15             # 胶带上浮高度（米）
TAPE_THICKNESS = 0.01                 # 胶带厚度（米）
```

## 5. 前置条件

### 5.1 数据要求
- 区域数据必须包含有效的`shape.points`数组
- 每个区域至少需要3个点形成多边形
- 点坐标必须是有效的数值

### 5.2 环境要求
- SketchUp环境已初始化
- 父组对象存在且有效
- 模型处于可编辑状态

### 5.3 依赖模块
- `Utils`模块：提供点验证和UTF-8编码处理
- `Geom`模块：提供几何计算功能
- SketchUp API：提供实体创建和属性设置功能

## 6. 关键代码展示

### 6.1 偏移多边形生成算法
```ruby
def self.generate_offset_polygon(original_points, offset_distance)
  return [] if original_points.size < 3
  
  # 计算每个边的法向量并生成偏移点
  offset_points = []
  
  (0...original_points.size).each do |i|
    p1 = original_points[i]
    p2 = original_points[(i + 1) % original_points.size]
    
    # 计算边的方向向量
    edge_vector = p2 - p1
    return [] if edge_vector.length < 1e-6
    
    # 计算法向量（垂直于边，指向外部）
    normal_vector = calculate_normal_vector(edge_vector)
    
    # 应用偏移
    offset_p1 = p1.offset(normal_vector, offset_distance)
    offset_p2 = p2.offset(normal_vector, offset_distance)
    
    offset_points << [offset_p1, offset_p2]
  end
  
  # 计算偏移线段的交点，形成闭合多边形
  offset_polygon = calculate_offset_polygon_intersections(offset_points)
  
  offset_polygon
end
```

### 6.2 线段交点计算
```ruby
def self.calculate_line_intersection(p1, p2, q1, q2)
  x1, y1 = p1.x, p1.y
  x2, y2 = p2.x, p2.y
  x3, y3 = q1.x, q1.y
  x4, y4 = q2.x, q2.y
  
  # 计算分母
  denom = (y4 - y3) * (x2 - x1) - (x4 - x3) * (y2 - y1)
  
  # 检查是否平行
  return nil if denom.abs < 1e-10
  
  # 计算参数
  ua = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / denom.to_f
  ub = ((x2 - x1) * (y1 - y3) - (y2 - y1) * (x1 - x3)) / denom.to_f
  
  # 检查参数是否在有效范围内
  return nil if ua < -0.1 || ua > 1.1 || ub < -0.1 || ub > 1.1
  
  # 计算交点坐标
  x = x1 + ua * (x2 - x1)
  y = y1 + ua * (y2 - y1)
  
  Geom::Point3d.new(x, y, 0)
end
```

### 6.3 胶带面创建
```ruby
def self.create_tape_face(tape_polygon, zone_name, parent_group, tape_layer, is_outdoor = false)
  return unless tape_polygon && tape_polygon.size >= 3
  
  # 上浮避免与区域重叠
  elevated_points = tape_polygon.map { |pt| Geom::Point3d.new(pt.x, pt.y, pt.z + TAPE_HEIGHT_OFFSET) }
  
  # 生成胶带面
  tape_face = parent_group.entities.add_face(elevated_points)
  return unless tape_face
  
  # 设置材质颜色
  tape_face.material = TAPE_COLOR
  tape_face.back_material = TAPE_COLOR
  
  # 设置胶带属性
  tape_face.set_attribute('FactoryImporter', 'tape_type', 'zone_boundary')
  tape_face.set_attribute('FactoryImporter', 'zone_name', zone_name)
  tape_face.set_attribute('FactoryImporter', 'tape_width', TAPE_WIDTH)
  tape_face.set_attribute('FactoryImporter', 'is_shared', false)
  tape_face.set_attribute('FactoryImporter', 'is_outdoor', is_outdoor)
  
  # 确保胶带面在胶带层上
  if tape_layer
    tape_face.layer = tape_layer
  end
  
  # 为胶带添加厚度
  tape_face.pushpull(TAPE_THICKNESS)
  
  tape_face
end
```

## 7. 使用流程

### 7.1 基本使用
```ruby
# 生成区域边界胶带
TapeBuilder.generate_zone_boundary_tapes(zones_data, parent_group)

# 生成外部区域边界胶带
TapeBuilder.generate_outdoor_zone_boundary_tapes(zones_data, parent_group)
```

### 7.2 自定义胶带对象
```ruby
# 创建胶带对象
tape = Tape.new(points, zone_name, parent_group, 
                is_shared: false, 
                tape_type: 'zone_boundary')

# 生成胶带面
tape_face = tape.create_face
```

## 8. 错误处理

### 8.1 数据验证
- 检查点集数量是否足够
- 验证点坐标的有效性
- 确保几何计算不会产生无效结果

### 8.2 异常捕获
- 使用begin-rescue块包装主要操作
- 提供详细的错误日志
- 确保程序在出错时能够继续运行

## 9. 性能考虑

### 9.1 算法优化
- 使用高效的几何计算算法
- 避免重复计算
- 合理设置数值精度阈值

### 9.2 内存管理
- 及时清理临时变量
- 避免创建过多中间对象
- 使用适当的数据结构

## 10. 扩展性

### 10.1 配置灵活性
- 支持自定义胶带颜色
- 可调整胶带尺寸参数
- 支持不同类型的胶带

### 10.2 功能扩展
- 支持更复杂的几何形状
- 可添加胶带动画效果
- 支持胶带的交互操作

---

