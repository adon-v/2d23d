# Utils模块方法说明文档

## 概述
`Utils`模块是工厂布局导入插件的核心工具库，提供几何计算、区域处理、数据验证和算法支持等功能。

## 主要功能分类

### 1. 几何计算工具
处理点、线、面的基本几何操作，包括坐标验证、凸包计算、线段相交等。

#### `validate_and_create_point(point_data)`
- **功能**: 验证并创建3D点
- **参数**: `point_data` - 点数据（数组或Point3d对象）
- **返回**: Geom::Point3d对象或nil
- **说明**: 支持数组和Point3d格式，自动缩放坐标（除以25.4），处理毫米到英寸的转换

#### `parse_number(value)`
- **功能**: 解析数值
- **参数**: `value` - 数值或字符串
- **返回**: 浮点数或nil
- **说明**: 支持数字和字符串格式，处理转换错误

#### `sort_rectangle_points(points)`
- **功能**: 对矩形点进行排序
- **参数**: `points` - 点数组
- **返回**: 排序后的点数组
- **说明**: 按角度排序，确保点的正确顺序

#### `compute_convex_hull_2d(points)`
- **功能**: 计算2D凸包
- **参数**: `points` - 点数组
- **返回**: 凸包点数组
- **说明**: 使用Graham扫描算法，忽略Z轴坐标

#### `cross(o, a, b)`
- **功能**: 计算叉积
- **参数**: `o, a, b` - 三个点
- **返回**: 叉积值
- **说明**: 用于凸包算法的辅助函数

#### `line_intersection_2d(p1, p2, q1, q2)`
- **功能**: 计算2D线段交点
- **参数**: `p1, p2` - 第一条线段的起点和终点
- **参数**: `q1, q2` - 第二条线段的起点和终点
- **返回**: 交点坐标或nil
- **说明**: 忽略Z轴，处理平行线情况

#### `segment_length_2d(p1, p2)`
- **功能**: 计算2D线段长度
- **参数**: `p1, p2` - 线段的起点和终点
- **返回**: 线段长度
- **说明**: 使用勾股定理，忽略Z轴

#### `project_point_on_segment_2d(point, seg_start, seg_end)`
- **功能**: 将点投影到线段上
- **参数**: `point` - 要投影的点
- **参数**: `seg_start, seg_end` - 线段的起点和终点
- **返回**: 投影点坐标
- **说明**: 计算点到线段的最近点

#### `point_on_segment_2d?(point, seg_start, seg_end, tolerance)`
- **功能**: 检查点是否在线段上
- **参数**: `point` - 要检查的点
- **参数**: `seg_start, seg_end` - 线段的起点和终点
- **参数**: `tolerance` - 容差值
- **返回**: 布尔值
- **说明**: 使用叉积和点积判断

### 2. 区域处理工具
负责工厂区域的创建和管理，处理区域重叠检测、边界共享、点优化等。

#### `create_zone_with_adjacency_handling(parent_group, zone_data, existing_zones)`
- **功能**: 创建区域并处理相邻关系
- **参数**: `parent_group` - 父组
- **参数**: `zone_data` - 区域数据
- **参数**: `existing_zones` - 现有区域列表
- **返回**: 区域组对象或nil
- **说明**: 创建区域面，设置材质，处理重叠检测

#### `zones_overlap?(zone_group, points)`
- **功能**: 检查两个区域是否重叠
- **参数**: `zone_group` - 现有区域组
- **参数**: `points` - 新区域的点
- **返回**: 布尔值
- **说明**: 使用边界框进行快速重叠检测

#### `calculate_bounds(points)`
- **功能**: 计算点集的边界框
- **参数**: `points` - 点数组
- **返回**: 边界框哈希表
- **说明**: 返回最小/最大X、Y、Z坐标

#### `points_equal?(p1, p2, tolerance)`
- **功能**: 检查两个点是否相同
- **参数**: `p1, p2` - 两个点
- **参数**: `tolerance` - 容差值
- **返回**: 布尔值
- **说明**: 考虑精度误差的点比较

#### `segments_share_boundary?(seg1_start, seg1_end, seg2_start, seg2_end, tolerance)`
- **功能**: 检查线段是否共享边界
- **参数**: 四条线段的起点和终点
- **参数**: `tolerance` - 容差值
- **返回**: 布尔值
- **说明**: 检测区域间的共享边界

#### `detect_shared_boundaries(zones_data)`
- **功能**: 检测区域之间的共享边界
- **参数**: `zones_data` - 区域数据数组
- **返回**: 共享边界数组
- **说明**: 分析所有区域间的边界关系

#### `optimize_zone_points(points, zone_name)`
- **功能**: 优化区域点
- **参数**: `points` - 原始点数组
- **参数**: `zone_name` - 区域名称
- **返回**: 优化后的点数组
- **说明**: 移除重复点，确保逆时针方向

#### `is_counterclockwise(points)`
- **功能**: 检查点序列是否为逆时针方向
- **参数**: `points` - 点数组
- **返回**: 布尔值
- **说明**: 使用面积计算判断方向

#### `add_zone_offset(points, zone_id, offset_distance)`
- **功能**: 为紧邻区域添加微小偏移
- **参数**: `points` - 点数组
- **参数**: `zone_id` - 区域ID
- **参数**: `offset_distance` - 偏移距离
- **返回**: 偏移后的点数组
- **说明**: 避免面冲突的微小调整

### 3. 数据验证工具
确保输入数据的正确性，处理编码问题、数值解析、对象查找等。

#### `ensure_utf8(str)`
- **功能**: 确保字符串是UTF-8编码
- **参数**: `str` - 输入字符串
- **返回**: UTF-8编码的字符串
- **说明**: 处理编码问题，支持多种编码转换

#### `find_wall_group(parent_group, wall_id)`
- **功能**: 找到对应的墙体组
- **参数**: `parent_group` - 父组
- **参数**: `wall_id` - 墙体ID
- **返回**: 墙体组对象或nil
- **说明**: 支持多种匹配方式（属性、名称、大小写不敏感）

### 4. 算法工具
提供流程排序、通道连接等算法支持。

#### `arr_close?(a, b, tol)`
- **功能**: 检查两个数组是否接近
- **参数**: `a, b` - 两个数组
- **参数**: `tol` - 容差值
- **返回**: 布尔值
- **说明**: 用于流程排序的数组比较

#### `sort_corridors(corridors)`
- **功能**: 自动排序通道段
- **参数**: `corridors` - 通道数组
- **返回**: 排序后的通道数组
- **说明**: 确保首尾相连，优化通道连接

## 使用场景

### 工厂布局导入
- 解析JSON中的坐标数据
- 创建墙体、门窗、区域等3D元素
- 处理区域间的空间关系

### 几何计算
- 计算区域面积和边界
- 检测元素间的碰撞和重叠
- 优化几何形状

### 数据验证
- 确保输入数据的完整性
- 处理编码和格式问题
- 验证坐标的有效性

## 注意事项

1. **坐标系统**: 默认使用毫米单位，自动转换为英寸
2. **精度处理**: 使用容差值处理浮点数精度问题
3. **错误处理**: 大部分方法都有错误处理机制
4. **性能优化**: 使用高效的算法（如Graham扫描）处理大量数据

## 依赖关系

- 依赖SketchUp的Geom模块进行几何计算
- 依赖SketchUp的Group和Entity系统
- 使用Ruby标准库进行字符串和数组操作 