# 设备生成功能设计文档

## 1. 功能概述

设备生成功能是工厂布局导入系统的核心组件，负责导入和放置各种生产设备。该功能支持从SKP模型库中导入真实的设备模型，并在导入失败时自动创建占位体，确保工厂布局的完整性和可视化效果。

## 2. 设计思路

### 2.1 核心设计理念
- **真实模型导入**：优先导入真实的SKP设备模型
- **占位体备用**：在模型导入失败时创建占位体
- **智能缩放**：根据设备尺寸自动调整模型比例
- **容错机制**：完善的错误处理和参数验证

### 2.2 设备类型分类
1. **SKP模型设备**：从模型库导入的真实设备
   - 支持复杂的几何形状
   - 保持原始材质和纹理
2. **占位体设备**：简化的几何体表示
   - 用于模型导入失败的情况
   - 基本的尺寸和位置信息

### 2.3 处理流程
1. **数据验证**：检查设备数据的有效性
2. **模型查找**：在SKP模型库中查找对应模型
3. **模型导入**：导入SKP模型并创建实例
4. **尺寸调整**：根据设备参数调整模型尺寸
5. **位置放置**：将设备放置到指定位置
6. **旋转应用**：应用设备的旋转角度
7. **占位体创建**：在导入失败时创建占位体

## 3. 模块结构

### 3.1 EquipmentBuilder模块

#### 主要功能
- 批量设备导入
- SKP模型导入
- 占位体创建
- 智能尺寸调整

#### 核心函数说明

**`import_equipments(equipments_data, parent_group)`**
- **作用**：批量导入所有设备
- **参数**：设备数据数组、父组对象
- **前置条件**：设备数据包含有效的skp_model属性

**`import_skp_component(parent_group, skp_filename, skp_lib_path, position, width, length, height, rotation)`**
- **作用**：导入SKP组件模型
- **参数**：父组、SKP文件名、模型库路径、位置、尺寸、旋转角度
- **返回**：布尔值，表示导入是否成功

**`create_placeholder(parent_group, position, width, length, height, rotation)`**
- **作用**：创建设备占位体
- **参数**：父组、位置、尺寸、旋转角度
- **前置条件**：位置和尺寸参数有效

## 4. 配置参数

### 4.1 设备尺寸参数
```ruby
# 默认设备尺寸（毫米）
DEFAULT_EQUIPMENT_WIDTH = 1000    # 默认设备宽度
DEFAULT_EQUIPMENT_LENGTH = 1000   # 默认设备长度
DEFAULT_EQUIPMENT_HEIGHT = 1000   # 默认设备高度

# 单位转换
MILLIMETER_TO_INCH = 0.0393701    # 毫米转英寸
INCH_TO_MILLIMETER = 25.4         # 英寸转毫米
```

### 4.2 模型库配置
```ruby
# SKP模型库路径
DEFAULT_SKP_LIB_PATH = "F:/组件库构建/skp组件"

# 模型文件扩展名
SKP_FILE_EXTENSION = ".skp"

# 占位体材质
PLACEHOLDER_MATERIAL = [200, 200, 200]  # 浅灰色
```

### 4.3 几何验证参数
```ruby
# 尺寸验证阈值
MIN_EQUIPMENT_SIZE = 0.001        # 最小设备尺寸（米）
MAX_EQUIPMENT_SIZE = 100.0        # 最大设备尺寸（米）

# 位置验证阈值
MIN_POSITION_DISTANCE = 0.001     # 最小位置距离
```

## 5. 前置条件

### 5.1 数据要求
- 设备数据必须包含有效的skp_model属性
- 设备位置数据（position数组，至少包含x和y坐标）
- 设备尺寸数据（width、length、height）
- 设备旋转角度（可选）

### 5.2 环境要求
- SketchUp环境已初始化
- 父组对象存在且有效
- SKP模型库路径可访问
- 模型处于可编辑状态

### 5.3 依赖模块
- `Utils`模块：提供点验证、数值解析和UTF-8编码处理
- `Geom`模块：提供几何计算和变换功能
- SketchUp API：提供组件定义和实例创建功能

## 6. 关键代码展示

### 6.1 SKP模型导入
```ruby
def self.import_skp_component(parent_group, skp_filename, skp_lib_path, position, width, length, height, rotation)
  model = Sketchup.active_model
  
  # 构建完整路径
  full_path = File.join(skp_lib_path, skp_filename)
  
  # 检查文件是否存在
  unless File.exist?(full_path)
    puts "警告: SKP文件不存在: #{full_path}"
    return false
  end
  
  begin
    # 创建组件定义
    definitions = model.definitions
    component_definition = definitions.load(full_path)
    
    if component_definition
      # 创建实例并放入设备组
      transform = Geom::Transformation.new
      instance = parent_group.entities.add_instance(component_definition, transform)
      
      if instance
        # 获取原始包围盒
        bounds = component_definition.bounds
        
        # 计算缩放比例
        scale_x = width / bounds.width
        scale_y = length / bounds.depth
        scale_z = height / bounds.height
        
        # 应用缩放变换
        scale_transform = Geom::Transformation.scaling(scale_x, scale_y, scale_z)
        instance.transformation = scale_transform
        
        # 应用位置变换
        position_transform = Geom::Transformation.translation(position)
        instance.transformation = position_transform * instance.transformation
        
        # 应用旋转变换
        if rotation != 0
          rotation_rad = rotation * Math::PI / 180
          rotation_transform = Geom::Transformation.rotation(position, Geom::Vector3d.new(0, 0, 1), rotation_rad)
          instance.transformation = rotation_transform * instance.transformation
        end
        
        puts "SKP模型导入成功: #{skp_filename}"
        return true
      end
    end
    
    false
  rescue => e
    puts "SKP模型导入失败: #{e.message}"
    false
  end
end
```

### 6.2 占位体创建
```ruby
def self.create_placeholder(parent_group, position, width, length, height, rotation)
  # 创建设备的四个角点
  points = [
    position,
    position + Geom::Vector3d.new(width, 0, 0),
    position + Geom::Vector3d.new(width, length, 0),
    position + Geom::Vector3d.new(0, length, 0)
  ]
  
  # 应用旋转（如果有）
  if rotation != 0
    rotation_rad = rotation * Math::PI / 180
    rotation_transform = Geom::Transformation.rotation(position, Geom::Vector3d.new(0, 0, 1), rotation_rad)
    points.map! { |p| p.transform(rotation_transform) }
  end
  
  # 创建设备面并拉伸
  equipment_face = parent_group.entities.add_face(points)
  if equipment_face
    equipment_face.pushpull(height)
    
    # 设置占位体材质
    equipment_face.material = PLACEHOLDER_MATERIAL
    equipment_face.back_material = PLACEHOLDER_MATERIAL
    
    puts "占位体创建成功"
    return true
  end
  
  false
end
```

### 6.3 设备数据验证
```ruby
def self.validate_equipment_data(equipment_data)
  return false unless equipment_data && equipment_data.is_a?(Hash)
  
  # 检查必要字段
  required_fields = ["skp_model", "position"]
  required_fields.each do |field|
    unless equipment_data[field]
      puts "警告: 设备数据缺少必要字段: #{field}"
      return false
    end
  end
  
  # 验证SKP模型文件名
  skp_model = equipment_data["skp_model"]
  unless skp_model && skp_model.is_a?(String) && !skp_model.empty?
    puts "警告: SKP模型文件名无效"
    return false
  end
  
  # 验证位置数据
  position_data = equipment_data["position"]
  unless position_data && position_data.is_a?(Array) && position_data.size >= 2
    puts "警告: 设备位置数据无效"
    return false
  end
  
  true
end
```

### 6.4 批量设备导入
```ruby
def self.import_equipments(equipments_data, parent_group)
  return if !equipments_data || equipments_data.empty?
  
  puts "开始导入设备组件..."
  equipment_count = 0
  skp_lib_path = "F:/组件库构建/skp组件"
  
  equipments_data.each do |equipment_data|
    begin
      # 检查必要数据
      equipment_id = equipment_data["id"] || "E#{rand(10000)}"
      equipment_name = equipment_data["name"] || "未命名设备"
      skp_model = equipment_data["skp_model"]
      
      unless skp_model
        puts "警告: 设备 #{equipment_id} (#{equipment_name}) 缺少skp_model属性，无法导入"
        next
      end
      
      # 获取设备参数
      width = Utils.parse_number(equipment_data["width"] || 1000) / 25.4  # mm转m
      length = Utils.parse_number(equipment_data["length"] || 1000) / 25.4 # mm转m
      height = Utils.parse_number(equipment_data["height"] || 1000) / 25.4 # mm转m
      rotation = Utils.parse_number(equipment_data["rotation"] || 0)  # 角度
      
      # 获取位置
      position_data = equipment_data["position"]
      if position_data && position_data.is_a?(Array) && position_data.size >= 2
        position = Geom::Point3d.new(
          Utils.parse_number(position_data[0]) / 25.4, 
          Utils.parse_number(position_data[1]) / 25.4, 
          0
        )
      else
        puts "警告: 设备 #{equipment_id} (#{equipment_name}) 位置无效，使用默认位置"
        position = Geom::Point3d.new(0, 0, 0)
      end
      
      # 创建设备组
      equipment_group = parent_group.entities.add_group
      equipment_group.name = "#{equipment_name} (#{equipment_id})"
      equipment_group.set_attribute('FactoryImporter', 'equipment_id', equipment_id)
      
      # 导入SKP模型
      if import_skp_component(equipment_group, skp_model, skp_lib_path, position, width, length, height, rotation)
        equipment_count += 1
        puts "成功导入设备: #{equipment_name} (#{equipment_id})"
      else
        # 如果SKP导入失败，创建占位体
        create_placeholder(equipment_group, position, width, length, height, rotation)
        equipment_count += 1
        puts "为设备 #{equipment_id} (#{equipment_name}) 创建了占位体"
      end
      
    rescue => e
      error_msg = "导入设备失败 (ID: #{equipment_data['id'] || '未知'}): #{Utils.ensure_utf8(e.message)}"
      puts Utils.ensure_utf8(error_msg)
    end
  end
  
  puts "设备导入完成，共导入 #{equipment_count} 个设备"
end
```

## 7. 使用流程

### 7.1 基本使用
```ruby
# 批量导入设备
equipments_data = [
  {
    "id" => "equipment1",
    "name" => "生产设备1",
    "skp_model" => "设备模型.skp",
    "position" => [1000, 1000, 0],
    "width" => 2000,
    "length" => 1500,
    "height" => 1800,
    "rotation" => 45
  }
]

EquipmentBuilder.import_equipments(equipments_data, parent_group)
```

### 7.2 单独导入SKP模型
```ruby
# 导入单个SKP模型
success = EquipmentBuilder.import_skp_component(
  parent_group, 
  "设备模型.skp", 
  "F:/组件库构建/skp组件",
  Geom::Point3d.new(0, 0, 0),
  2.0, 1.5, 1.8, 0
)
```

### 7.3 创建占位体
```ruby
# 创建设备占位体
EquipmentBuilder.create_placeholder(
  parent_group,
  Geom::Point3d.new(0, 0, 0),
  2.0, 1.5, 1.8, 45
)
```

## 8. 错误处理

### 8.1 数据验证
- 检查设备数据的完整性
- 验证SKP模型文件的存在性
- 确保位置和尺寸参数有效

### 8.2 模型导入验证
- 检查SKP文件格式的有效性
- 验证组件定义的创建
- 确保实例创建成功

### 8.3 异常捕获
- 使用begin-rescue块包装主要操作
- 提供详细的错误日志
- 确保程序在出错时能够继续运行

## 9. 性能考虑

### 9.1 模型加载优化
- 高效的SKP文件加载
- 优化的组件定义管理
- 合理的实例创建策略

### 9.2 内存管理
- 及时清理临时变量
- 避免创建过多中间对象
- 使用适当的数据结构

### 9.3 文件系统优化
- 缓存模型库路径
- 优化文件存在性检查
- 减少重复的文件访问

## 10. 扩展性

### 10.1 模型库扩展
- 支持多种模型格式
- 可添加模型分类管理
- 支持模型的版本控制

### 10.2 设备类型扩展
- 支持不同类型的设备
- 可添加设备的材质和纹理
- 支持设备的动画效果

### 10.3 配置灵活性
- 支持自定义模型库路径
- 可调整设备尺寸参数
- 支持不同的单位系统

---
 